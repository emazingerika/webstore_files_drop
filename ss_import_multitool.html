<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SS Import – Matrixify Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { font-size: 1.5em; }
        .container { max-width: 1200px; margin: auto; }
        .section { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        table, th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        select, input, button, textarea { margin-top: 10px; padding: 6px; width: 100%; }
        .links { margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h1>SS Import Tool</h1>
    <div class="section">
        <label for="toolSelect">Choose Tool:</label>
        <select id="toolSelect">
            <option value="matrixify">A: SS Import – Matrixify Tool</option>
            <option value="received">B: Received Inventories Tool</option>
        </select>
    </div>
    <div class="section">
        <label for="fileInput">Upload CSV Data:</label>
        <input type="file" id="fileInput" accept=".csv">
    </div>
    <div class="section">
        <label for="poInput">Enter PO Numbers (comma, tab, or newline separated):</label>
        <textarea id="poInput" rows="3"></textarea>
    </div>
    <button onclick="processData()">Generate</button>
    <button onclick="generateAgain()">Generate Again</button>
    <div class="links">
        <p><b>Bulk Update to this link: MATRIXIFY IMPORT</b></p>
        <p>iHR: <a href="https://admin.shopify.com/store/iheartraves/apps/excel-export-import" target="_blank">Matrixify Import</a></p>
        <p>ITAM: <a href="https://admin.shopify.com/store/into-the-am/apps/excel-export-import" target="_blank">Matrixify Import</a></p>
    </div>
    <div id="output"></div>
    <button id="downloadCsvBtn" style="display:none;" onclick="downloadCSV()">Download CSV</button>
    <button id="downloadXlsxBtn" style="display:none;" onclick="downloadXLSX()">Download XLSX</button>
</div>
<script>
let parsedData = [];
let filteredData = [];
function generateAgain() {
    document.getElementById('output').innerHTML = '';
    document.getElementById('downloadCsvBtn').style.display = 'none';
    document.getElementById('downloadXlsxBtn').style.display = 'none';
}
document.getElementById('fileInput').addEventListener('change', function(event) {
    Papa.parse(event.target.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            parsedData = results.data;
            alert("CSV loaded with " + parsedData.length + " rows");
        }
    });
});
function processData() {
    if (parsedData.length === 0) {
        alert("Please upload a CSV file first.");
        return;
    }
    let poNumbers = document.getElementById('poInput').value
        .split(/[\n,\t ]+/)
        .map(s => s.trim())
        .filter(s => s);
    if (poNumbers.length === 0) {
        alert("Please enter at least one PO Number.");
        return;
    }
    let tool = document.getElementById('toolSelect').value;
    filteredData = parsedData.filter(row => poNumbers.includes(row["Purchase Order"]));
    if (tool === "matrixify") {
        filteredData = filteredData.map(row => {
            let [length, width, height] = (row["Unit Dimension"] || "").split("x").map(s => s.trim());
            let weightGrams = Math.round(parseFloat(row["Unit Weight"] || "0") * 1000);
            return {
                "Variant SKU": row["SKU"],
                "Variant Weight": weightGrams,
                "Variant Command": "UPDATE",
                "Variant Metafield: info.harmonized_system_code [single_line_text_field]": row["Shopify Product Type"],
                "Variant Metafield: info.dimensional_groups [single_line_text_field]": "Default",
                "Variant Metafield: info.origins [single_line_text_field]": "Main",
                "Variant Metafield: info.shipping_groups [single_line_text_field]": "All Products not assigned to a Shipping Group",
                "Variant Metafield: info.length [single_line_text_field]": length || "",
                "Variant Metafield: info.width [single_line_text_field]": width || "",
                "Variant Metafield: info.height [single_line_text_field]": height || "",
                "Quantity On Hand": row["QOH"],
                "Primary Location": row["Primary Location"],
                "Statusv2": row["Statusv2"]
            };
        });
        filteredData.sort((a, b) => a["Variant SKU"].localeCompare(b["Variant SKU"]));
    } else {
        filteredData = filteredData.map(row => ({
            "Purchase Order": row["Purchase Order"],
            "SKU": row["SKU"],
            "Title": row["Title"],
            "QOH": row["QOH"],
            "Statusv2": row["Statusv2"]
        }));
    }
    displayTable(filteredData);
    document.getElementById('downloadCsvBtn').style.display = 'inline-block';
    document.getElementById('downloadXlsxBtn').style.display = 'inline-block';
}
function displayTable(data) {
    let output = "<table><thead><tr>";
    Object.keys(data[0]).forEach(key => output += `<th>${key}</th>`);
    output += "</tr></thead><tbody>";
    data.forEach(row => {
        output += "<tr>";
        Object.values(row).forEach(val => output += `<td>${val}</td>`);
        output += "</tr>";
    });
    output += "</tbody></table>";
    document.getElementById('output').innerHTML = output;
}
function downloadCSV() {
    let csv = Papa.unparse(filteredData);
    let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "output.csv";
    link.click();
}
function downloadXLSX() {
    let ws = XLSX.utils.json_to_sheet(filteredData);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "output.xlsx");
}
</script>
</body>
</html>
