
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SS Import – Matrixify Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea, input, button, select { margin: 10px 0; display: block; width: 100%; max-width: 600px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .link-block a { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>SS Import – Matrixify Tool</h1>
  <label>Upload CSV Report:</label>
  <input type="file" id="csvFileInput" accept=".csv" />

  <label>Enter PO Number(s) (comma, tab, or space separated):</label>
  <textarea id="poNumbers"></textarea>

  <div class="link-block">
    <strong>Bulk Update to this link:</strong>
    <a href="https://admin.shopify.com/store/iheartraves/apps/excel-export-import" target="_blank">iHR: Matrixify Import</a>
    <a href="https://admin.shopify.com/store/into-the-am/apps/excel-export-import" target="_blank">ITAM: Matrixify Import</a>
  </div>

  <button onclick="processCSV()">Generate Output</button>
  <button onclick="downloadXLSX()">Download XLSX</button>

  <div id="output"></div>

  <script>
    let inputData = [];
    let processedData = [];

    function parseUnitDimension(dimStr) {
      const parts = dimStr.split('x').map(p => p.trim());
      return {
        length: parts[0] || '',
        width: parts[1] || '',
        height: parts[2] || ''
      };
    }

    function convertWeightToGrams(weight) {
      return Math.round(parseFloat(weight) * 1000);
    }

    function parsePONumbers(input) {
      return input.split(/[\s,\t]+/).map(po => po.trim()).filter(Boolean);
    }

    document.getElementById('csvFileInput').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        inputData = XLSX.utils.sheet_to_json(sheet);
      };
      reader.readAsBinaryString(e.target.files[0]);
    });

    function processCSV() {
      const poInput = document.getElementById('poNumbers').value;
      const poList = parsePONumbers(poInput);
      processedData = [];

      inputData.forEach(row => {
        const poName = row['Purchase Order: Purchase Order Name'] || row['Purchase Order'];
        if (poList.includes(poName)) {
          const unitDimension = parseUnitDimension(row['Unit Dimension'] || '');
          const unitWeight = convertWeightToGrams(row['Unit Weight'] || 0);

          processedData.push({
            'Variant SKU': row['B2C Product: SKU'] || row['SKU'],
            'Variant Weight': unitWeight,
            'Variant Command': 'UPDATE',
            'Variant Metafield: info.harmonized_system_code [single_line_text_field]': row['Shopify Product Type'] || '',
            'Variant Metafield: info.dimensional_groups [single_line_text_field]': 'Default',
            'Variant Metafield: info.origins [single_line_text_field]': 'Main',
            'Variant Metafield: info.shipping_groups [single_line_text_field]': 'All Products not assigned to a Shipping Group',
            'Variant Metafield: info.length [single_line_text_field]': unitDimension.length,
            'Variant Metafield: info.width [single_line_text_field]': unitDimension.width,
            'Variant Metafield: info.height [single_line_text_field]': unitDimension.height
          });
        }
      });

      renderTable();
    }

    function renderTable() {
      const output = document.getElementById('output');
      if (processedData.length === 0) {
        output.innerHTML = '<p>No matching data found.</p>';
        return;
      }
      const headers = Object.keys(processedData[0]);
      let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
      processedData.forEach(row => {
        html += '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>';
      });
      html += '</tbody></table>';
      output.innerHTML = html;
    }

    function downloadXLSX() {
      if (processedData.length === 0) return alert('No data to export.');
      const ws = XLSX.utils.json_to_sheet(processedData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Matrixify Import');
      XLSX.writeFile(wb, 'ss_import_matrixify_output.xlsx');
    }
  </script>
</body>
</html>
