<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SS Import – Matrixify Tool</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea, input[type="text"] { width: 100%; padding: 8px; margin: 8px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: left; }
    button { padding: 10px 20px; margin: 10px 5px; }
    h1, h3 { margin-top: 40px; }
  </style>
  <script>
    let inputData = {};

    function parseInputData() {
      const raw = document.getElementById('dataInput').value.trim();
      const lines = raw.split("\n");
      inputData = {};

      lines.forEach(line => {
        const parts = line.split("\t");
        const [externalId, poName, sku, style, title, weight, dimension, ...rest] = parts;

        if (!sku) return;

        inputData[sku] = {
          externalId,
          poName,
          sku,
          style,
          title,
          weight,
          dimension,
          hsCode: rest[0] || '',
          qoh: rest[1] || '',
          location: rest[2] || '',
          status: rest[3] || '',
        };
      });

      alert("Data parsed. Now enter PO Number(s) to lookup.");
    }

    function generateOutput() {
      const output = document.getElementById('output');
      output.innerHTML = "";
      const poNumbers = document.getElementById('poLookup').value.trim().split(/[,\s]+/);

      const header = [
        "Variant SKU", "Variant Weight", "HS Code", "QOH", "Primary Location", "StatusV2",
        "Variant Metafield: info.harmonized_system_code [single_line_text_field]",
        "Variant Metafield: info.dimensional_groups [single_line_text_field]",
        "Variant Metafield: info.origins [single_line_text_field]",
        "Variant Metafield: info.shipping_groups [single_line_text_field]",
        "Variant Metafield: info.length [single_line_text_field]",
        "Variant Metafield: info.width [single_line_text_field]",
        "Variant Metafield: info.height [single_line_text_field]"
      ];

      let table = document.createElement("table");
      let tr = document.createElement("tr");
      header.forEach(h => {
        let th = document.createElement("th");
        th.innerText = h;
        tr.appendChild(th);
      });
      table.appendChild(tr);

      for (let sku in inputData) {
        if (poNumbers.includes(inputData[sku].poName)) {
          let row = document.createElement("tr");

          const [l = '', w = '', h = ''] = (inputData[sku].dimension || '').split("x");
          const weightInGrams = Math.round(parseFloat(inputData[sku].weight || 0) * 1000);

          const rowData = [
            sku,
            weightInGrams,
            inputData[sku].hsCode,
            inputData[sku].qoh,
            inputData[sku].location,
            inputData[sku].status,
            inputData[sku].hsCode,
            "Default",
            "Main",
            "All Products not assigned to a Shipping Group",
            l.trim(), w.trim(), h.trim()
          ];

          rowData.forEach((value, i) => {
            let cell = document.createElement("td");
            if ([5].includes(i)) {
              const input = document.createElement("input");
              input.value = value;
              input.addEventListener('input', () => {
                rowData[i] = input.value;
              });
              cell.appendChild(input);
            } else {
              cell.innerText = value;
            }
            row.appendChild(cell);
          });

          table.appendChild(row);
        }
      }

      output.appendChild(table);
    }

    function downloadCSV() {
      let csv = [];
      const rows = document.querySelectorAll("table tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = Array.from(cols).map(col => col.innerText);
        csv.push(rowData.join(","));
      });

      const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'SS_Import_Matrixify.csv';
      a.click();
    }
  </script>
</head>
<body>
  <h1>SS Import – Matrixify Tool</h1>

  <p><strong>Instructions:</strong> Paste raw data from Salesforce using <kbd>Ctrl+Shift+V</kbd>.<br>
    Refer to this report: 
    <a href="https://emazing.my.salesforce.com/00O3r000006mGeP" target="_blank">
      SS Import Drop Report
    </a>
  </p>

  <textarea id="dataInput" rows="10" placeholder="Paste tab-separated data here..."></textarea><br>
  <button onclick="parseInputData()">Parse Input</button>

  <h3>Lookup PO Number(s):</h3>
  <input type="text" id="poLookup" placeholder="Enter PO Numbers separated by comma, space, or tab">
  <button onclick="generateOutput()">Lookup and Generate Table</button>

  <h3>Bulk Update Links</h3>
  <ul>
    <li><a href="https://admin.shopify.com/store/iheartraves/apps/excel-export-import" target="_blank">iHR</a></li>
    <li><a href="https://admin.shopify.com/store/into-the-am/apps/excel-export-import" target="_blank">ITAM</a></li>
  </ul>

  <h3>Output Table</h3>
  <div id="output"></div>
  <button onclick="downloadCSV()">Download CSV</button>
</body>
</html>
